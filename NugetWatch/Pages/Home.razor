@page "/"
@page "/{Owner}"
@inject NugetMonitorService NugetMonitorService
@implements IDisposable

<div class="home-body">
    <div>
        @if (NoOwnerSpecified)
        {
            <div>Select or Add a Nuget owner</div>
        }
        else
        {
            var owner = Owner;
            var totalDownloads = NugetMonitorService.GetOwnerTotalDownloads(owner);
            var packages = NugetMonitorService.OwnerPackagesByTotalDownloads(owner);
            <div>
                <h2>
                    @owner
                </h2>
                <div>
                    @($"Packages: {packages.Count}")
                </div>
                <div>
                    @($"Downloads: {totalDownloads}")
                </div>
            </div>
            <div class="package-data-list">
                @foreach (var package in packages)
                {
                    var isActive = package.Active(TimeSpan.FromMinutes(5));
                    <div class="package-data">
                        <div style="display: flex; flex-direction: row;">
                            <div style="padding-right: 4px;"><img style="width: 24px; height: 24px;" onerror="this.src='default-package-icon-256x256.png'; this.onerror = null;" src="@(package.IconUrl ?? "default-package-icon-256x256.png")" /></div>
                            <div style="padding: 2px;">
                                <div style="font-weight: bold;">
                                    @package.Title @package.Version - <span style="@(isActive ? "color: red;" : "")">@package.TotalDownloads</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <DownloadsOverTime Data="package" />
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? Owner { get; set; }

    bool NoOwnerSpecified => string.IsNullOrWhiteSpace(Owner);

    [Inject]
    NavigationManager NavigationManager { get; set; } = default!;

    protected override void OnInitialized()
    {
        NugetMonitorService.OnPackageChange += NugetMonitorService_OnPackageChange;
        NugetMonitorService.UpdateEnd += UpdateEnd;
    }
    protected override void OnAfterRender(bool firstRender)
    {
        // if the owner does not exist, we redirect back to the root page
        if (!NoOwnerSpecified)
        {
            var ownerFound = NugetMonitorService.Owners.Contains(Owner!);
            if (!ownerFound)
            {
                NavigationManager.NavigateTo("");
            }
        }
    }
    public void Dispose()
    {
        NugetMonitorService.OnPackageChange -= NugetMonitorService_OnPackageChange;
        NugetMonitorService.UpdateEnd -= UpdateEnd;
    }
    void UpdateEnd()
    {
        StateHasChanged();
    }
    void NugetMonitorService_OnPackageChange(List<NugetPackageChangeEventArg> args)
    {
        StateHasChanged();
    }
}